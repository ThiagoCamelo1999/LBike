<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - LBike</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Cabe√ßalho da p√°gina com logo e navega√ß√£o -->
    <header class="header">
        <div class="logo">
            <a href="index.html">
                <img src="./logo.png" alt="imgLogo">
            </a>
        </div>
        <nav class="navbar">
            <ul>
                <li><a href="funcionarios.html">Funcion√°rios</a></li>
                <li><a href="items.html">Estoque</a></li>
                <li><a href="loja.html">Loja</a></li>
                <li><a href="pedidos.html">Pedidos</a></li>
                <button id="logoutButton" class="logout-btn">Sair</button>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Bot√£o para alternar a exibi√ß√£o do formul√°rio de cria√ß√£o de agendamento -->
        <button id="toggleFormButton">Criar Agendamento</button>
        <div id="formContainer" style="display: none;">
            <h2>Criar Agendamento</h2>
            <form id="agendamentoForm">
                <input type="text" name="cliente_nome" placeholder="Nome do Cliente" required>
                <input type="text" name="cliente_telefone" placeholder="Telefone do Cliente" required>
                <input type="text" name="cliente_endereco" placeholder="Endere√ßo do Cliente" required>
                <input type="text" name="servico" placeholder="Tipo do Servi√ßo" required>
                <input type="text" name="data_hora" placeholder="Data do Agendamento" required>
                <button type="submit">Criar Agendamento</button>
            </form>
        </div>

        <!-- Lista de agendamentos -->
        <h2>Lista de Agendamentos</h2>
        <ul id="agendList">
            <li class="list-header">
                <span>Nome do Cliente</span>
                <span>Telefone</span>
                <span>Endere√ßo</span>
                <span>Servi√ßo</span>
                <span>Data</span>
            </li>
            <ul id="agendamentoList"></ul>
        </ul>

        <!-- Formul√°rio de edi√ß√£o de agendamento -->
        <div id="editFormContainer" style="display: none;">
            <h2>Editar Agendamento</h2>
            <form id="editAgendamentoForm">
                <input type="text" name="cliente_nome" placeholder="Nome do Cliente">
                <input type="text" name="cliente_telefone" placeholder="Telefone">
                <input type="text" name="cliente_endereco" placeholder="Endere√ßo">
                <input type="text" name="servico" placeholder="Servi√ßo">
                <input type="text" name="data_hora" placeholder="Data e Hora">
                <button type="submit">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </main>

    <!-- Rodap√© da p√°gina -->
    <footer>
        <p>&copy; 2024 LBike. Todos os direitos reservados.</p>
    </footer>

    <!-- Scripts JavaScript -->
    <script src="scripts.js"></script>
    <script>
        // Fun√ß√£o principal para inicializar eventos da p√°gina
        function initEvents() {
            const agendamentoForm = document.getElementById('agendamentoForm');

            if (agendamentoForm) {
                // Listener para cria√ß√£o de agendamentos
                agendamentoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(agendamentoForm);
                    const data = Object.fromEntries(formData.entries());

                    try {
                        await createResource('agendamentos', data); // Fun√ß√£o para salvar no backend
                        agendamentoForm.reset(); // Limpa o formul√°rio
                        loadAgendamentos(); // Atualiza lista
                    } catch (error) {
                        alert(error.message);
                    }
                });
                loadAgendamentos(); // Carrega agendamentos na inicializa√ß√£o
            }
        }

        // Carrega os agendamentos do backend e exibe na lista
        async function loadAgendamentos() {
            const agendamentoList = document.getElementById('agendamentoList');

            if (agendamentoList) {
                agendamentoList.innerHTML = '';

                try {
                    const agendamentos = await getAllResources('agendamentos'); // Recupera do backend
                    agendamentos.forEach(item => {
                        const li = document.createElement('li');
                        li.classList.add('list-item');

                        // Exibe os dados e a√ß√µes (editar/excluir)
                        li.innerHTML = `
                            <span>${item.cliente_nome}</span>
                            <span>${item.cliente_telefone}</span>
                            <span>${item.cliente_endereco}</span>
                            <span>${item.servico}</span>
                            <span>${item.data_hora}</span>
                            <button onclick="editAgendamento(${item.id})">Editar</button>
                            <button onclick="deleteAgendamento(${item.id})">Excluir</button>
                        `;
                        agendamentoList.appendChild(li);
                    });
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        // Exclui um agendamento via API
        async function deleteAgendamento(agendamentoId) {
            const confirmation = confirm("Tem certeza que deseja excluir este agendamento?");
            if (!confirmation) return;

            try {
                const response = await fetch(`http://localhost:3000/api/agendamentos/${agendamentoId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) throw new Error('Erro ao excluir o agendamento');

                alert('Agendamento exclu√≠do com sucesso');
                loadAgendamentos();
            } catch (error) {
                alert(error.message);
            }
        }

        // Prepara os dados para edi√ß√£o de agendamento
        async function editAgendamento(agendamentoId) {
            const editFormContainer = document.getElementById('editFormContainer');
            const editAgendamentoForm = document.getElementById('editAgendamentoForm');

            try {
                const agendamento = await getResourceById(`agendamentos/${agendamentoId}`);

                // Preenche o formul√°rio de edi√ß√£o com dados existentes
                Object.keys(agendamento).forEach(key => {
                    if (editAgendamentoForm[key]) {
                        editAgendamentoForm[key].value = agendamento[key];
                    }
                });

                editFormContainer.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        }

        // Atualiza o agendamento editado
        document.getElementById('editAgendamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                await updateResource(`agendamentos/${editingAgendamentoId}`, data);
                e.target.reset();
                document.getElementById('editFormContainer').style.display = 'none';
                loadAgendamentos();
            } catch (error) {
                alert(error.message);
            }
        });

        // Alterna exibi√ß√£o do formul√°rio de cria√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            const toggleFormButton = document.getElementById('toggleFormButton');
            const formContainer = document.getElementById('formContainer');

            toggleFormButton.addEventListener('click', () => {
                const isHidden = formContainer.style.display === 'none' || formContainer.style.display === '';
                formContainer.style.display = isHidden ? 'block' : 'none';
                toggleFormButton.textContent = isHidden ? 'Cancelar' : 'Criar Agendamento';
            });
        });

        // Inicializa eventos quando a p√°gina √© carregada
        window.onload = initEvents;

        document.addEventListener("DOMContentLoaded", () => {
            const tipo_usuario = localStorage.getItem("tipo_usuario");

            if (tipo_usuario !== "dono") {
                window.location.href = "index.html"; // üîπ Redireciona clientes para a p√°gina inicial
            }
        });

        document.getElementById("logoutButton").addEventListener("click", () => {
    localStorage.clear(); // üîπ Remove todos os dados do usu√°rio
    window.location.replace("login.html"); // üîπ Usa replace() para evitar voltar para a p√°gina anterior
});

    </script>
</body>

</html>